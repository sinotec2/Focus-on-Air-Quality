---
layout: default
title: LGHAP檔案之切割與平均
parent: LGHAP
grand_parent: Regional AQ Data
nav_order: 2
date: 2023-02-04 14:22:44
last_modified_date: 2023-02-04 14:22:39
tags: NASA Satellite
---

# LGHAP數據之切割與平均
{: .no_toc }

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .text-delta }
- TOC
{:toc}
</details>
---

## 背景

- LGHAP[^1]檔案名稱規則、檔案格式詳見[zip下載與轉檔](1.get_zip.md)
- 由於該檔案的空間範圍為全中國，因此需先將其切割出台灣範圍、再行轉換座標或其他處理。
- 由於來源及目標座標系統之解析度相同，此處以「最近距離」法來進行內插與轉檔(如[建立cmaq邊界點位置與cams網格系統的對照關係](../../GAQuality/ECMWF_CAMS/3.CAMS_bc.md#建立cmaq邊界點位置與cams網格系統的對照關係bconingrbpy)或[](../../GAQuality/NASA_MCD19A2.006/2.genN_D4T.md))
- 此處著重程式說明，程式詳[rdPM25.py][rdPM25.py]及[tmPM25.py][tmPM25.py]

## 切割方式


- 由[zenodo][zenodo]網站取得zip檔案之網址後，以規則化檔名進行下載。規則為
  - 目錄：https://zenodo.org/record/5652265/files/
  - 檔名：LGHAP.PM25.D001.Y$y.zip

```bash
for y in 20{00..20};do 
wget -q https://zenodo.org/record/5652265/files/LGHAP.PM25.D001.Y$y.zip;done &
```

### 解壓縮

- 內容為日均值
- 每天存一個檔案
- 檔案規則：`LGHAP.${spec}.D001.A${YYYYMMDD}.nc`

```bash
for i in 20{00..20};do unzip *${i}*.zip;done
```

## 轉檔

### 檔案格式

- 為自行定義之ncf檔案。(不是CF、ioaip、USGS等 convention)
- 2個維度：先是經度、再來是緯度(需轉置)
- 因使用正值作為nan(海上)之替代值，且該值似乎不同年度有異，需特別注意。

```bash
netcdf LGHAP.PM25.D001.A20151018 {
dimensions:
        lat = 4100 ;
        lon = 6800 ;
variables:
        float lat(lat) ;
        float lon(lon) ;
        ushort PM25(lon, lat) ;
                PM25:_FillValue = 65535US ;
                PM25:units = "micrograms per cubic meter (μg m**-3)" ;
                PM25:scale_factor = 1. ;
                PM25:add_offset = 0. ;

// global attributes:
                :_NCProperties = "version=2,netcdf=4.7.3,hdf5=1.8.12," ;
}
```

### 將LGHAP轉成ioapi濃度檔

- 使用rdPM25.py(個別轉檔)或tmPM25.py(求取平均值並轉檔)，轉成CMAQ濃度檔(ioapi convention)；
- 全年合併成1個檔案
- 引數：年代
- 詳見[程式說明][rdPM25.md]

```bash
for i in 20{00..20};do sub python rdPM25.py $i ;done

for i in 20{00..20};do sub python tmPM25.py $i ;done
```

### 程式碼下載

{% include download.html content="切割並轉檔
[rdPM25.py][rdPM25.py]" %}

{% include download.html content="求取年平均[tmPM25.py][tmPM25.py]" %}

[^1]: Long-term Gap-free High-resolution Air Pollutants concentration dataset provides gap free AOD product with daily 1-km resolution covering the land area of China. see [publication][Bao]

[Bao]: https://doi.org/10.5194/essd-14-907-2022 "Bai, Kaixu, Ke Li, Mingliang Ma, Kaitao Li, Zhengqiang Li, Jianping Guo, Ni-Bin Chang, Zhuo Tan and Di Han. LGHAP: The Long-Term Gap-Free High-Resolution Air Pollutant Concentration Dataset, Derived via Tensor-Flow-Based Multimodal Data Fusion. Earth System Science Data 14, no. 2, 2022/2/24: 907–27."
[rdPM25.py]: https://github.com/sinotec2/Focus-on-Air-Quality/blob/main/AQana/GAQuality/LGHAP/rd_PM25.py "LGHAP數據中PM2.5切割並轉檔"
[tmPM25.py]: https://github.com/sinotec2/Focus-on-Air-Quality/blob/main/AQana/GAQuality/LGHAP/tmPM25.py "求取LGHAP數據中PM2.5年平均程式"