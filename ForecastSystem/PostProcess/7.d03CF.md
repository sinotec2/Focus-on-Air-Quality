---
layout: default
title: D03模擬結果並列播放
parent: FCST Post Processing
grand_parent: Forecast Systems
nav_order: 7
date: 2023-07-28
last_modified_date: 2023-08-28 14:18:34
tags: forecast CMAQ
---

# D03模擬結果並列播放

{: .no_toc }

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .text-delta }
- TOC
{:toc}
</details>
---

## 背景

- 在工作站node03完成前述[習作](6.NCDR_demo.md)迄今也超過一個月，可以再多加一些功能。
- 此處將各單位（中央大學大氣系NCU、中研院大氣變遷中心SNC、此處預報SES）的預報結果放在一起比較、目標是做成「叢集預報」。這樣不再是一單位的獨斷預報，而是綜合各單位的預測，可以讓使用者可以有更多的訊息，做出最佳的判斷。
- 要達成這個目標的技術性困難在於：
  1. 目前網站上並沒法取得各單位的數值預報結果，只能有個別的結果畫面，不能重新消化、製圖(參考[從png檔案讀取濃度][1])。
  2. 即使畫面也是有困難，畫面大小不一、檔案型態分歧，如何轉檔而不失真？
  3. 如何將這些圖檔一起放映在網頁上？是要個別使用播放器呢？還是將圖檔整併成一個。
  4. 原網站是要廢去？同步運作？還是單獨成立新的網頁？
- 幾經嘗試，發現要同時驅動不同js程式展現個別圖片，基本上是不可能達成，必須將3張圖片整合成一張，才可能正確同步播放。前述問題似乎只有一個答案：就是在原來的domain選項之外、另外再加上3張合輯的選項的成果比較。

## 圖檔來源及下載時間點

### sinica檔案之下載

- sinica檔案是個gif檔案，在每一天的8:06會完成下載。可以先行處理圖檔。在11:00時再予以拼接。

### NCU結果之下載

- NCU結果會在上午與夜間10:00公開在災害防救科技中心。
- 因此，只能在11:00那次的上載作業中處理這一部分。
- 這也表示執行腳本需要設計跳脫機制：如果沒有檔案，則不執行轉檔與整併。

### SES模擬結果之上載

- 正常狀況下，在每天的子夜之前會完成所有的模擬工作，將結果上載到node03備用。並在隔天早上8:00將結果上載到GitHub，讓外部單位可以下載。
- 雖然如此，crontab還是安排自從8:00後，每3小時執行一次上載到網站上。

### node03 crontab的安排

- 執行SES圖檔上載之後，視情況執行3單位圖檔的整併。

```bash
6 8/11/14 * * * root /var/www/html/time-bar/pngs/pngs2jfy.sh
```

## html之因應修改

### 圖框之扁平化

- 舊圖框：`<div id="TAIWAN_TOWN_id_1_p" style="float:center;;width:1120px;height:650px;`
- 新圖框：`<div id="TAIWAN_TOWN_id_1_p" style="float:center;;width:1100px;height:550px;`

### 新增下拉選單項目

- 舊選單

```html
<optgroup title="台灣本島與澎湖解析度3k" label="D03">
    <option value="PM25_d03" selected>PM2.5</option>
</select>
```

- 新選單。合併後圖檔名稱前綴：`PM25_all`。

```html
<optgroup title="台灣本島與澎湖解析度3k" label="D03">
    <option value="PM25_d03" selected>PM2.5</option>
<optgroup title="SES,sinica,NCU比較" label="D03CF">
    <option value="PM25_all">PM2.5</option>
</optgroup>
</select>
```

## 自動執行腳本

- 在原本[pngs2jfy.sh](6.NCDR_demo.md#自動執行腳本)結束之後，再加上以下處理程序。

### 暫存檔目錄

- 因gif拆解、縮放、調整邊框等等，需要一個地方存放暫存檔。
- 這個設計是考量最後可以把暫存檔完全刪除，不影響儲存。

```bash
D=$(echo $T|cut -c8-15)
cd $root/$T
mkdir -p origin;cd origin
```

### sinica(SNC)圖檔之處理

- SNC圖檔會在8:06處理完，在後續(11/14：00)則不需要再處理一遍。
- 如果沒有圖檔（因為失誤）則跳出不做。
- convert在整併圖檔時，一律向上對齊、不會自動調整垂直置中、必須手動調整。
- 此處應用`-border W%xH%`選項，調整上下邊框增加15%。15%為試誤結果。
- 拆解後逐一進行壓縮尺寸，並加上下邊框。在同一行指令直接處理。

```bash
n=$(ls snc*png|wc -l)
if [[ $n -eq 0 ]];then
  snc=/nas2/cmaqruns/2022fcst/grid03/cctm.fcst/daily/sinica/$D.gif
  test ! -e $snc && exit
  ln -s $snc .
  /bin/convert -coalesce $D.gif $D.png
  i=0
  for d in 0 1 2;do
    for h in {0..23};do
      datep=$(date -d "$D + ${d}days +${h}hours" +%Y%m%d%H )
      /bin/convert ${D}-$i.png -resize 77% -bordercolor white -border 0%x15% snc_$datep.png
      i=$(( $i + 1 ));done;done;fi
```

### NCU圖檔之處理

- NCU圖檔會在10:00處理好（@dev2），8:00時不會處理、會在11:00處理。如果已經處理過(11:00)，就不再重複執行(14:00)。
- 因為jfy.cs作業結果不會存留過去每一天的png檔，因此如果nas2還有原始的png檔案（當日），則直接連結過來，否則將由gif檔案再次拆解產生。
- NCU的初始圖檔起自4:00，共72個檔案。時間如果與SES結果切齊，最後4個小時將不會有圖片可供顯示。
- 雖然NCU圖幅比較大，但臺灣範圍相對其他單位成果比較都小，因此反而還需要再放大142%。
- 因為NCU圖檔的上下範圍是3者中最大，不需要（也不能）再調整邊框。

```bash
n=$(ls ncu*png|wc -l)
if [[ $n -eq 0 ]];then
  N=ncdr-PM25_d03_
  jfy=/nas2/cmaqruns/2022fcst/grid03/cctm.fcst/daily/jfy
  if [[ -e $jfy/${N}${D}04.png ]];then
    ln -s $jfy/*png .
  else
    test ! -e $jfy/jfy${D}02.gif && exit
    ln -s $jfy/jfy${D}02.gif .
    /bin/convert -coalesce jfy${D}02.gif jfy.png
    i=0
    for d in 0 1 2;do
      for h in {0..23};do
        m=$(( $h + 4 ))
        datep=$(date -d "$D + ${d}days +${m}hours" +%Y%m%d%H )
        mv -f jfy-$i.png $N$datep.png
        i=$(( $i + 1 ));done;done;fi
  for f in $(ls ${N}*png);do
    datep=$(echo $f|cut -d'_' -f3|cut -d'.' -f1)
    /bin/convert $N${datep}.png -resize 142% ncu_$datep.png ;done;fi
```

### 為SES圖檔添加上下邊框

- convert在整併圖檔時，一律向上對齊、不會自動調整垂直置中、必須手動調整。
- 為使臺灣島能垂直置中、便於比較，其他2個圖檔需與NCU圖檔之臺灣位置能對齊。
- 此處應用`-border W%xH%`選項，經試誤上下邊框增加26%。
- 不取代原檔案，避免干擾SES原網頁D03畫面。

```bash
for f in $(ls ../PM25_d03*.png);do
  fn=$(echo $f|cut -d'/' -f2)
  /bin/convert -bordercolor white -border 0%x26% $f $fn;done
```

### 合併圖檔

- SES模擬第一天是初始化（前一天），那些結果在`make_gifs.cs`中已經刪除。
- SES從8：00開始播放。共需執行72個frame。
- 因為時間切齊的緣故，NCU及SNC結果在第三天可能會有些不足。以最後出現的圖檔來墊檔。

```bash
cd $root/$T
for d in 0 1 2;do
  for h in {0..23};do
    m=$(( $h + 8 ))
    datep=$(date -d "$D + ${d}days +${m}hours" +%Y%m%d%H )
    fn=$datep.png
    f1=origin/PM25_d03_$fn;f2=origin/snc_$fn;f3=origin/ncu_$fn
    test ! -e $f1 && f1=$f1O;test ! -e $f2 && f2=$f2O;test ! -e $f3 && f3=$f3O
    /bin/convert $f1 $f2 $f3 +append PM25_all_$fn
    f1O=$f1;f2O=$f2;f3O=$f3;done;done
```

### 結果

|![](https://github.com/sinotec2/Focus-on-Air-Quality/raw/main/attachments/2023-08-28-11-33-55.png)|
|:-:|
|本計畫SES(左),中研院環變中心SNC(中),中央大物所NCU(右)未來3日PM<sub>2.5</sub>預報結果之比較|

## CMAQ模式PM<sub>2.5</sub>預報結果比較

- 因未能取得其他單位模擬結果的數據檔案，以下討論僅限於定性探討。

### 風場對濃度場的效果

- 從這各單位的海面上的濃度梯度來討論風場模擬結果。如果風速較大，濃度煙流會拉得較長、沿流方向得梯度會較小，反之，則較大、煙流看起來較短。
- 由此來看，不論是海上或陸上，SES模擬分布的變異度及梯度都是最大，NCU或SNC的梯度較小，模擬風速似乎較大。
- 造成模擬風速較大的原因很多。因SES大量使用FDDA，來使模擬值逼近給定風場，這可能是模擬風速較低的原因。
- 就空氣污染角度來說，風速大可能會得到較低的污染物濃度，因此會得到較不保守的結果，而SES則可能得到較保守的模擬結果。

### 海面的PM<sub>2.5</sub>沉降量

- 一般來說SES在海面上的PM<sub>2.5</sub>濃度會最高，陸地煙流被環流帶出到海面上之後，濃度不會驟然下降，能夠維持較久，也因此旅行較大範圍，這顯示SES的公版模式設定在海面沉降損失最小。其次為NCU、SNC的沉降非常嚴重。
- 海面上的損失較小，使得回流至陸地的濃度就會較高，這也是SES模擬PM<sub>2.5</sub>濃度較高的重要原因之一。
- 早期的CMAQ模擬海面上的二次氣膠有顯著的低估情形，對污染模擬較不保守，這可能是學術單位對此仍有保留。SES模式採用公版模式之設定，而公版模式已將此一效應減到最低，以使結果有較大的保守性。

### 雨水對PM<sub>2.5</sub>的洗滌效應

- 雨水是氣象模式預報的重點項目，但在空氣污染卻為洗除效應，是使模式偏向不保守的因素之一。由陸域低濃度的分布特性來看，SES有較大片區域是濃度低於2&mu;g/m<sup>3</sup>以下的範圍，NCU為最大、其次為SNC，SES則為最低。
- 一者可能因為地表沉降的損失較低、再者可能因為降雨量的估計較低，也可能雨水對PM<sub>2.5</sub>的洗滌係數設定較低，造成SES低濃度範圍不如期他2各單位，這些也顯示公版模式設定會較為保守。

### 山谷間PM<sub>2.5</sub>的濃度累積

- 夜間與清晨，SES模擬山谷內會發生PM<sub>2.5</sub>濃度累積的結果，可能因地面風速較低、垂直混合有限，也可能因為去除機制(包括地面沉降或雨水洗滌的效果)較其他單位為低，因此造成明顯濃度累積的斑塊花紋。
- 發生位置如花東縱谷中央山脈之間，以及南投縣、台中市的山區。
- 如果山區沒有降雨，隨著每天的日出，這一分布特徵會逐漸淡化均勻消失，而入夜之後再逐漸累積生成。倘若山區有降雨、雲霧等現象，也會將累積的較高濃度予以淨化。

### 高空PM<sub>2.5</sub>煙流的模擬能力

- 台灣地區的大型電廠都位於濱海地區，其高空煙流在地面上的PM<sub>2.5</sub>濃度貢獻一直是大家關切的主題。此處乃由此一角度來檢討3各單位的模式預報結果。
- 由地面動態模擬結果來看，SES模擬的高空煙流濃度最高，其次為NCU，SNC模擬最低。影響高空煙流的設定除了前述海面的沉降係數、雨水的洗滌係數之外，也與大型煙流的排放位置有關，如果估計煙流排放高度較低，可能會造成地面濃度太高，反之則會造成地面濃度太低。由模擬結果來看，SNC估計的煙流高度最高、其次為NCU，而SES則最低。
- 由於公版模式一律將電廠高空煙流設定在第5(K4)層位置(詳見[高層排放量敏感性分析](https://sinotec2.github.io/Focus-on-Air-Quality/GridModels/TWNEPA_RecommCMAQ/emis_sens/5emis_KLayer/)的討論)，對於出口溫度較低的煙囪將會嚴重低估其濃度貢獻，而對出口溫度較高的煙囪，則為高估。
- 為解決此一問題，此處乃以系統性方式解決，以CMAQ點源內部線上計算程式自行計算每小時應存在的高度，而不是公版檔案固定高度的作法，以符合實際。
- 驗證結果，此一設定在其他2各單位的比較之下，仍顯得較為保守，可知此設定方式並不會損失保守性，同時也較為合理。

### 地面煙團的模擬能力

- 造成地面PM<sub>2.5</sub>煙團(煙陣或煙流)的主要原因是地面排放源，包括高速公路的密集排放、以及都會區、工業區等原生性PM<sub>2.5</sub>之污染源。此處檢討這些污染源對PM<sub>2.5</sub>濃度的敏感特性。
- 此3單位模擬結果以NCU的敏感性最高，這些地面污染源很容易造成較高的濃度而向下游傳送。其次為SES。SNC為最不敏感。而因SES的沉降機制最低，因此傳送到下游的量是最高，由這些污染源造成的濃度分布看來較NCU均勻。
- 目前尚未得知其他2單位排放量處理的方法原則，無法進一步評論模式敏感性影響的變因。

[1]: https://sinotec2.github.io/Focus-on-Air-Quality/utilities/Graphics/rdpng/ "由圖面顏色讀取濃度值"
