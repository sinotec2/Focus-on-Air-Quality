---
layout: default
title: 2.水平向量及純量之分布
parent: wrf-python
grand_parent: Graphics
last_modified_date: 2022-05-27 10:50:18
---

# 水平向量及純量之分布
{: .no_toc }

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .text-delta }
- TOC
{:toc}
</details>
---

## 背景
- [wrf-python官網](https://wrf-python.readthedocs.io/en/latest/plot.html)提供了SLP與等壓面高度分布圖的基本作法。只需進行必要的修改即可使用。
- 除了壓力，此處也應用到垂直溫差([KO index](http://www.eumetrain.org/data/2/20/Content/theory_ko.htm))分布圖的繪製，以利空污事件過程氣象數據的分析。
  - 垂直擴散能力的指標有幾，經嘗試大多並不理想
    - CAPE、CIN：似與雲雨有關，並非連續的場，解析能力有限
    - [K值](https://en.wikipedia.org/wiki/K-index_(meteorology))
      - K=(T<sub>850</sub>-T<sub>500</sub>)+T<sub>d850</sub>-(T<sub>700</sub>-T<sub>d700</sub>)
      - T=temp
      - 沒有0值的概念，不如KO直觀。
    - [KO index](http://www.eumetrain.org/data/2/20/Content/theory_ko.htm)
      - KO = ((T<sub>700</sub> + T<sub>500</sub>) - (T<sub>850</sub> + T<sub>1000</sub>))/2.
      - T=ETH (Equivalent Potential Temperature)
      - 事件會伴隨KO=0通過臺灣地區(GFS與WRF皆然)

## 程式IO與執行
### wrf檔案之準備
- 因跨日處理，需先將逐日wrfout連成一個檔案備用

```bash
d=/nas1/WRF4.0/WRFv4.2/201903/wrfout/wrfout_d03_2019-03-
t=_00\:00\:00
ncrcat -O ${d}29$t ${d}30$t ${d}31$t ${d}29-31
ln -s ${d}29-31 .
```
- 原程式`ncfile = Dataset("wrfout_d01_2016-10-07_00_00_00")`

- 因應不同月、日、與domain的wrfout，將輸入檔變成可程式化檔名

```python
d=sys.argv[1] #domain
t=int(sys.argv[2]) #iobaric value
n=2     #frequency of wind bars
if d=='4':n=4
mt='03'
dt='29'
dt2='31'
ncfile = Dataset("wrfout_d0"+d+"_2019-"+mt+"-"+dt+"-"+dt2)
```
### NaturalEarthFeature檔案之連線
- 這項cartopy的底圖檔，並不需要特別準備。
  - 第一次使用時，程式會自動從[Natural Earth官網](https://www.naturalearthdata.com/)自行下載。只需保持網路暢通即可。
  - 後續同一使用者就不會需要再下載。
- 除了行政區界如有別的底圖需要，可以參考
  - [Python feature.NaturalEarthFeature方法代碼示例](https://vimsky.com/zh-tw/examples/detail/python-method-cartopy.feature.NaturalEarthFeature.html)，或
  - [官網](https://scitools.org.uk/cartopy/docs/v0.14/matplotlib/feature_interface.html)說明。
  - [zip檔下載點](https://www.naturalearthdata.com/downloads/)
- 原程式：load檔名是`admin_1_states_provinces_shp`

```python
states = NaturalEarthFeature(category="cultural", scale="50m",
                             facecolor="none",
                             name="admin_1_states_provinces_shp")
ax.add_feature(states, linewidth=.5, edgecolor="black")
ax.coastlines('50m', linewidth=0.8)
```
- 因臺灣範圍較小，需有縣市界，因此增加解析度到10m，
  - 從臺灣屬中國範圍，檔案名稱沒有`_shp`
  - 修改後：
```python
# Download and add the states and coastlines
states = NaturalEarthFeature(category="cultural", scale="10m",
                             facecolor="none",
                             name="admin_1_states_provinces")
ax.add_feature(states, linewidth=0.5, edgecolor="black")
ax.coastlines('50m', linewidth=0.8)
```

### 輸出檔案
- 原範例是show圖在x window上，因為需要作的圖頗多，如果能存檔將可有利檔案管理。
- 檔名變數
  - iso：壓力值(hPa)
  - t：wrfout檔案內的小時順序，0~nt-1
  - d：domain,1~4

```python
...
#plt.show()
plt.savefig(str(iso)+'_'+'{:02d}'.format(t)+'D'+d+'.png')
```
### 程式執行方式
- `fig = plt.figure(figsize=(12,9))`指令似乎需要close，不能在時間的do loop中重複開啟。目前仍採一次一圖方式執行
- 好在不同時間作圖彼此不會干擾，可以平行運作。
- sub(mit)的用法，可以詳[unix系統小工具-sub](https://sinotec2.github.io/Focus-on-Air-Quality/utilities/OperationSystem/unix_tools/#sub)

```bash
for d in 1 2 3 4;do for t in {4..40..6};do sub python iso.py $d $t;done;done

for d in 1 2 3 4;do for t in {4..40..6};do sub python KO_index.py $d $t;done;done
```
## 程式設計
### 等值區間的設定
- 因程式同時應用在不同的小時序，因此最大、最小值的範圍要先讀完所有時間的數據後，統一設定
- tlst：time frame list，共7筆
- fac：因最大濃度會超出最後一個等候，wrf-python的contourf程式會將其空白，因此範圍需拉大一些，不能正好等於最大值。
#### [iso.py]()
- 取exp再取log值：因為等值線偏向高值，在高值部分較為平緩，無法辨識。

```python
...
shp = [7]+list(getvar(ncfile, "pressure").shape)
p0=np.zeros(shape=shp)
z0=np.zeros(shape=shp)
tlst=[i for i in range(4,41,6)]
for it in tlst:
  i=tlst.index(it)
  p0[i,:,:,:] = getvar(ncfile, "pressure",timeidx=it)
  z0[i,:,:,:] = getvar(ncfile, "z", units="dm",timeidx=it)
ht_iso0 = interplevel(z0, p0, iso)
fac=1.01
n=2     #frequency of wind bars
if d=='4':
  n=5
  fac=1.0007
elif d=='3':
  fac=1.002
mx,mn=10**(np.max(ht_iso0)*fac/100.),10**(np.min(ht_iso0)/100)

levels0= np.arange(mn, mx, (mx-mn)/10)
levels = [np.log10(i)*100 for i in levels0]
...
```
#### [KO_index.py]()

```python
p0=np.zeros(shape=shp)
T=np.zeros(shape=shp)
W=np.zeros(shape=shp)
tlst=[i for i in range(4,41,6)]
for it in tlst:
  i=tlst.index(it)
  p0[i,:,:,:] = getvar(ncfile, "pressure",timeidx=it)
  T[i,:,:,:] = getvar(ncfile, "eth",units="K",timeidx=it)
  W[i,:,:,:] = getvar(ncfile, "omg",timeidx=it)*3600./100.
lvls=[500,700,850,1000]
for lvl in lvls:
  ilvl=lvls.index(lvl)
  slvl=str(lvl)
  exec("T"+slvl+" = interplevel(T, p0, "+slvl+")")
#  check eth at mountain region, if nan, let equal to upper layer THE(adiabatic condition)
  if lvl>500:
    uplvl=str(lvls[ilvl-1])
    exec("T"+slvl+" = np.where(np.isnan(T"+slvl+"),T"+uplvl+",T"+slvl+")")
KO0 = ((T700 + T500) - (T850 + T1000))/2.
mx,mn=np.round(np.max(W)*1.2,0),np.round(np.min(W),0)
mn,mx=-54,1
levels = list(range(mn,-22,8))+list(range(-22,mx,2))
```

### 設定
- 垂直剖線的起訖點：不限定是X或Y方向、可以是任意點
```python
# Define the cross section start and end points
cross_start = CoordPair(lat=24.453917871182558, lon=120.225062233815342,)
cross_end = CoordPair(lat=23.41214780981217, lon=121.79586963982419)
```

- 高度：因wrfout有40層之多，大多是自由流範圍，因此必須限定繪圖的上邊界，凸顯邊界層現象。

```python
dbz_contours = ax_cross.contourf(xs,
                                 ys[:-80],
                                 to_np(dbz_cross_filled)[:-80,:],
                                 levels=dbz_levels,
                                 cmap="rainbow",
                                 norm=dbz_norm,
                                 extend="max")
```
- X軸標籤的有效位數
  - wrf-python使用經緯度tuple作為標籤，有效位數未經修剪長短不齊。此處統一修為2碼
  - 由於原程式是運用to_np之解讀程式，將coord_pairs經緯度值讀成字串，需將其拆解後方能改變有效位數。

```python
x_labels = [pair.latlon_str() for pair in to_np(coord_pairs)]
lab=[[round(float(i),2) for i in j.split(',')] for j in x_labels[:]]
x_labels=[str(i[0])+','+str(i[1]) for i in lab]
```
- [色標](https://sinotec2.github.io/Focus-on-Air-Quality/utilities/Graphics/wrf-python/1.basic/#色標)
  - 原程式為自主設定。不但顏色沒有連續、也不具辨識能力。
  - cmap選項有："jet"、"rainbow"、適用所有[matplotlib選項](https://matplotlib.org/stable/tutorials/colors/colormaps.html)，
  - 選擇考量見[wrf-python 安裝與基本指令 色標](https://sinotec2.github.io/Focus-on-Air-Quality/utilities/Graphics/wrf-python/1.basic/#色標)

```python
cmap="rainbow",
```
- 任意方向上的沿流方向風速分量
  - 計算分量後，U及W與濃度一樣進行垂直內插到等間距網格上
  - $ U =  u \times cost + v \times sint $;
    - `lent = np.sqrt((x1-x0)**2+(y1-y0)**2)`
    - `cost = (x1-x0)/lent`
    - `sint = (y1-y0)/lent`
    
- 貼上向量
  - 參考[stackoverflow](https://stackoverflow.com/questions/42117049/plotting-wind-vectors-on-vertical-cross-section-with-matplotlib)
  - 使用matplotlib[quiver](https://matplotlib.org/3.5.0/api/_as_gen/matplotlib.pyplot.quiver.html)指令來畫箭頭，中文可參考[程式人生](https://www.796t.com/content/1546226540.html)
  - 同樣使用[:-80]來限定高度範圍、[::2]來控制箭頭的密度

```python
ax_cross.quiver(xs[::2], ys[:-80],
          to_np(u_cross_filled[:-80, ::2]), to_np(w_cross_filled[:-80, ::2]))
```

### Parallel Operation
- 因程式沒有時間前後的交互作用，各個時間可以獨立運作。
- 將時間(小時順序)作為引數

```bash

```
### GIF Producing
- 使用[imageMagick](https://imagemagick.org/script/convert.php)串連

```bash
convert pm2.5*.png PMF.gif
```

### 程式碼
- [ver_ZhonBu.py@github](https://github.com/sinotec2/Focus-on-Air-Quality/blob/main/GridModels/TWNEPA_RecommCMAQ/emis_sens/ver_ZhonBu.py)

## Results
- [gif player](https://sinotec2.github.io/PM2.5CrossSect/)

| ![wrf-python.png](https://github.com/sinotec2/Focus-on-Air-Quality/raw/main/assets/images/wrf-python.png) |
|:--:|
| <b>圖 CCTM模擬d04範圍中部地區垂直PM<sub>2.5</sub>濃度分布(wrf-python繪製)，[動態播放](https://sinotec2.github.io/PM2.5CrossSect/)，單位&mu;g/M<sup>3</sup> </b>|  


## Reference
- Gene Z. Ragen, discussion on [Plotting wind vectors on vertical cross-section with matplotlib](https://stackoverflow.com/questions/42117049/plotting-wind-vectors-on-vertical-cross-section-with-matplotlib) 2019, Oct. 8.