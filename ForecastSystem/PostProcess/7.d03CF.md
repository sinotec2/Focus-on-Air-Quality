---
layout: default
title: D03模擬結果並列播放
parent: FCST Post Processing
grand_parent: Forecast Systems
nav_order: 7
date: 2023-07-28
last_modified_date: 2023-07-28 16:39:49
tags: forecast CMAQ
---

# D03模擬結果並列播放

{: .no_toc }

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .text-delta }
- TOC
{:toc}
</details>
---

## 背景

- [習作](6.NCDR_demo.md)完成迄今也超過一個月，可以再多加一些功能。
- 心目中總是希望能夠做到「叢集預報」：將各家的預報結果放在一起比較。這樣不再是一家的獨斷預報，而是綜合各家的預測，可以讓使用者可以有更多的訊息，做出最佳的判斷。
- 要達成這個目標的技術性困難在於：
  1. 目前網站上並沒法取得各家的數值預報結果，只能有個別的結果畫面，不能重新消化、製圖(參考[從png檔案讀取濃度][1])。
  2. 即使畫面也是有困難，畫面大小不一、檔案型態分歧，如何轉檔而不失真？
  3. 如何將這些圖檔一起放映在網頁上？是要個別使用播放器呢？還是將圖檔整併成一個。
  4. 原網站是要廢去？同步運作？還是單獨成立新的網頁？

## 圖檔來源及下載時間點

### SES模擬結果之上載

正常狀況下，在每天的子夜之前會完成所有的模擬工作，將結果上載到node03備用。並在隔天早上8:00將結果上載到GitHub，讓外部單位可以下載。
雖然如此，crontab還是安排自從8:00後，每3小時執行一次上載到網站上。

### NCU結果之下載

NCU結果會在上午與夜間10:00公開在災害防救科技中心。
因此，只能在11:00那次的上載作業中處理這一部分。
這也表示執行腳本需要設計跳脫機制：如果沒有檔案，則不執行轉檔與整併。

### sinica檔案之下載

sinica檔案是個gif檔案，在每一天的8:06會完成下載。可以先行處理圖檔。在11:00時再予以拼接。

## html之因應修改

### 圖框之扁平化

舊圖框：`<div id="TAIWAN_TOWN_id_1_p" style="float:center;;width:1120px;height:650px;`
新圖框：`<div id="TAIWAN_TOWN_id_1_p" style="float:center;;width:1100px;height:550px;`

### 新增下拉選單項目

舊選單

```html
<optgroup title="台灣本島與澎湖解析度3k" label="D03">
    <option value="PM25_d03" selected>PM2.5</option>
</select>
```

新選單

```html
<optgroup title="台灣本島與澎湖解析度3k" label="D03">
    <option value="PM25_d03" selected>PM2.5</option>
<optgroup title="SES,sinica,NCU比較" label="D03CF">
    <option value="PM25_all">PM2.5</option>
</optgroup>
</select>
```

合併後圖檔名稱前綴：`PM25_all`

## 自動執行腳本

### 暫存檔目錄

因gif拆解、縮放、調整邊框等等，需要一個地方存放暫存檔。最後可以完全刪除，不影響儲存。

```bash
### dissociate the sinica gifs

D=$(echo $T|cut -c8-15)
cd $root/$T
mkdir -p origin;cd origin
```

### sinica(SNC)圖檔之處理

- SNC圖檔會在8:06處理完，在後續(11/14)則不需要再處理一遍。
- 如果沒有圖檔（因為失誤）則跳出不做。
- 拆解後逐一進行壓縮尺寸，並加上下邊框。

```bash
n=$(ls snc*png|wc -l)
if [[ $n -eq 0 ]];then
  snc=/nas2/cmaqruns/2022fcst/grid03/cctm.fcst/daily/sinica/$D.gif
  test ! -e $snc && exit
  ln -s $snc .
  /bin/convert -coalesce $D.gif $D.png
  i=0
  for d in 0 1 2;do
    for h in {0..23};do
      datep=$(date -d "$D + ${d}days +${h}hours" +%Y%m%d%H )
      /bin/convert ${D}-$i.png -resize 77% -bordercolor white -border 0%x15% snc_$datep.png
      i=$(( $i + 1 ));done;done;fi
```

### NCU圖檔之處理

- 如果已經處理過(11:00)，就不再重複執行(14:00)。
- 如果還有當天原始的png檔案（過去日期），則直接連結過來，否則則由gif檔案拆解產生。
- NCU的初始圖檔起自4:00，共72個檔案。
- 雖然圖幅比較大，但臺灣範圍比較小，因此還需要再放大142%。
- 不需再要調整邊框

```bash
n=$(ls ncu*png|wc -l)
if [[ $n -eq 0 ]];then
  N=ncdr-PM25_d03_
  jfy=/nas2/cmaqruns/2022fcst/grid03/cctm.fcst/daily/jfy
  if [[ -e $jfy/${N}${D}04.png ]];then
    ln -s $jfy/*png .
  else
    test ! -e $jfy/jfy${D}02.gif && exit
    ln -s $jfy/jfy${D}02.gif .
    /bin/convert -coalesce jfy${D}02.gif jfy.png
    i=0
    for d in 0 1 2;do
      for h in {0..23};do
        m=$(( $h + 4 ))
        datep=$(date -d "$D + ${d}days +${m}hours" +%Y%m%d%H )
        mv -f jfy-$i.png $N$datep.png
        i=$(( $i + 1 ));done;done;fi
  for f in $(ls ${N}*png);do
    datep=$(echo $f|cut -d'_' -f3|cut -d'.' -f1)
    /bin/convert $N${datep}.png -resize 142% ncu_$datep.png ;done;fi
```

### 為SES圖檔添加上下邊框

- 以便讓臺灣島能垂直置中，與NCU圖檔之臺灣位置能對齊
- 26%為試誤結果
- 不取代原檔案，避免干擾原網頁畫面。

```bash
for f in $(ls ../PM25_d03*.png);do
  fn=$(echo $f|cut -d'/' -f2)
  /bin/convert -bordercolor white -border 0%x26% $f $fn;done
```

### 合併圖檔

- SES模擬第一天是初始化，結果在`make_gifs.cs`中已經刪除。
- SES從8：00開始播放。共需執行72個frame
- NCU及SNC第三天可能會有些不足。以最後的圖檔來墊檔。

```bash
cd $root/$T
for d in 0 1 2;do
  for h in {0..23};do
    m=$(( $h + 8 ))
    datep=$(date -d "$D + ${d}days +${m}hours" +%Y%m%d%H )
    fn=$datep.png
    f1=origin/PM25_d03_$fn;f2=origin/snc_$fn;f3=origin/ncu_$fn
    test ! -e $f1 && f1=$f1O;test ! -e $f2 && f2=$f2O;test ! -e $f3 && f3=$f3O
    /bin/convert $f1 $f2 $f3 +append PM25_all_$fn
    f1O=$f1;f2O=$f2;f3O=$f3;done;done
```

[1]: https://sinotec2.github.io/Focus-on-Air-Quality/utilities/Graphics/rdpng/ "由圖面顏色讀取濃度值"