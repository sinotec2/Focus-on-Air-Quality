---
layout: default
title: 5.parellel m3nc2gif 
parent: wrf-python
grand_parent: Graphics
last_modified_date: 2022-12-13 17:03:13
---

# m3nc2GIF平行轉檔
{: .no_toc }

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .text-delta }
- TOC
{:toc}
</details>
---

## 背景

- 本程式為[m3nc2GIF][4.]的平行版本

## 程式差異

### 引數

1. m3nc檔名：與原本[m3nc2GIF][4.]相同，以下為新增輸入項目
2. 年月日時：指定轉檔的時間框架(UTC)
3. 輸出png檔案的順序碼：以避免被覆蓋
4. 批次作業的極小值：避免
5. 批次作業的極大值

```python
$ diff m3nc2gif.py m3nc2gifP.py
37c37
< fname=sys.argv[1]
---
> fname,ymdh,iseq=sys.argv[1] ,sys.argv[2], int(sys.argv[3])
65,70c65,66
<   a=nc[v][:,0,:,:]
<   a=np.where(a==a,a,-1)
<   a=np.where(a>0,a,0)
<   mxv=np.percentile(a,99.99)
<   print (mxv)
<   mnv=np.max([np.percentile(a,0.01),mxv/100])
---
>   mnv=float(sys.argv[4])
>   mxv=float(sys.argv[5])
```

### 確認時間框架

```python
76a73,75
>     sdate=(bdate+timedelta(hours=t)).strftime("%Y%m%d%H")
>     if sdate != ymdh :continue
>     sdate=(bdate+timedelta(hours=t)).strftime("%Y-%m-%d_%H:00Z")
111d109
<     sdate=(bdate+timedelta(hours=t)).strftime("%Y-%m-%d_%H:00Z")
```

### 輸出檔案名稱與後處理

- 暫存檔
  - 平行作業的暫存檔必須有獨特的檔名，以避免被覆蓋。
  - 個別產生、也個別刪除
- GIF檔案製作
  - 取消在python階段製作，改在批次檔中統一製作

```python
123c121,122
<     png=v+'_'+'{:03d}'.format(t)+'.png'
---
>     png=v+'_'+'{:03d}'.format(iseq)+'.png'
>     pngt=png.replace('.png', 'tmp.png')
126,129c125,127
<     os.system(CVT+' -bordercolor white -trim '+png+' tmp.png')
<     os.system(CVT+' -bordercolor white -border 5%x5% tmp.png '+png)
<   size=subprocess.check_output(CVT+' '+v+'_000.png -format "%wx%h" info:',shell=True).decode('utf8').strip('\n')
<   os.system(CVT+' -dispose 2 -coalesce +repage -background none '+v+'_*.png -size '+size+' '+v+'.gif')
---
>     os.system(CVT+' -bordercolor white -trim '+png+' '+pngt)
>     os.system(CVT+' -bordercolor white -border 5%x5% '+pngt+' '+png)
>     os.system('rm -f '+pngt)
```

[4.]: <https://sinotec2.github.io/Focus-on-Air-Quality/utilities/Graphics/wrf-python/4.m3nc2gif/> "m3nc檔案轉GIF"
