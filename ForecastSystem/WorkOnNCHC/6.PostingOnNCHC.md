---
layout: default
title: 後處理方式的差異
parent: Works on NCHC
grand_parent: Forecast Systems
nav_order: 6
date: 2023-03-17
last_modified_date: 2023-03-24 21:17:44
tags: forecast CMAQ nchc_service m3nc2gif
---

# 預報系統後處理方式的差異

{: .no_toc }

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .text-delta }
- TOC
{:toc}
</details>
---

## 背景

- 為得到綜合性的空氣品質項目(粒狀物與VOC's)，需要執行combine，程序上包括[combine.exe](../../GridModels/POST/1.run_combMM_R_DM.md)與[shk.cs][shk]
- [國網][nchc]作業的特色之一就是磁碟空間的限制。/home/\$USERNAME與/work/\$USERNAME 下各有100G的免費空間，雖然可以申請增加容量上限，但終究也不是免費。這對作業系統後處理程序來說是很大的一個考量。

## 合併與壓縮

### combine.sh

- 這個腳本基本上還能保持環保署公版模式的原來樣貌。(參)
1. 增加[slurm][slurm]設定值，此處設定使用ct56之10個執行緒。
2. combine.exe使用環保署公版模式版本
3. $SPECIES_DEF檔案中開啟VOC's的計算

```bash
#sinotec2@lgn301 /work/sinotec2/cmaqruns/forecast
#$ cat combine.sh 
#!/bin/sh
#SBATCH -A ENT111040             # Account name/project number
#SBATCH -J comb                  # Job name
#SBATCH -p ct56                  # Partiotion name
#SBATCH -n 10                    # Number of MPI tasks (i.e. processes)
#SBATCH -c 1                     # Number of cores per MPI task
#SBATCH -N 1                     # Maximum number of nodes to be allocated
#SBATCH --ntasks-per-node=10    # Maximum number of tasks on each node
#SBATCH -o rsl.out.%j            # Path to the standard output file
#SBATCH -e rsl.error.%j          # Path to the standard error ouput file
module load compiler/intel/2021 IntelMPI/2021 hdf5/1.12 netcdf/4.7.4 pnetcdf/1.12.2

nc=$1
ii=$(echo $nc|cut -d'/' -f6|cut -c5-6)
ymd=$(echo $nc|cut -d'_' -f7|cut -d'.' -f1)
export BASE=/work/sinotec2/cmaqruns/forecast
export BLD=/work/sinotec2/opt/cmaq_recommend/POST/combine/scripts/BLD_combine_v532_intel
export EXEC=$BLD/combine_v532.exe
export m3input=${BASE}/grid$ii
export cctmout=${BASE}/grid$ii/cctm.fcst/daily

# user define
#> File [1]: CMAQ conc/aconc file
#> File [2]: MCIP METCRO3D file
#> File [3]: CMAQ APMDIAG file
#> File [4]: MCIP METCRO2D file
export INFILE2=${m3input}/mcip/METCRO3D.nc
export INFILE4=${m3input}/mcip/METCRO2D.nc

# programs
export LC_ALL=C
export LANG=C
export GENSPEC=N
export SPECIES_DEF=${BASE}/SpecDef_cb6r3_ae7_aq.txt
export INFILE1=$nc
export INFILE3=${nc/ACONC/APMDIAG}
export OUTFILE=${cctmout}/out${ymd}.conc.nc
if [ -e ${OUTFILE} ]; then rm ${OUTFILE};fi

time mpirun -bootstrap slurm -n 10 ${EXEC} >& ${BASE}/cmb.out
if [ -e ${cctmout}/PMs$ymd.nc ];then rm ${cctmout}/PMs$ymd.nc;fi
${BASE}/shk.cs $OUTFILE ${cctmout}/PMs$ymd.nc
if [ -e ${OUTFILE} ]; then rm ${OUTFILE};fi
```

### chk.cs

- 唯一需要修改的是[NCO][nco]程式的路徑。
- 此處沒有使用rcec/tools中的程式，而是使用自行編譯、較新版本的程式。

```bash
sinotec2@lgn301 /work/sinotec2/cmaqruns/forecast
$ cat shk.cs 
#!/bin/sh
nc=$1
NCO=/work/sinotec2/opt/cmaq_recommend/bin
NCKS=${NCO}/ncks
NCRCAT=${NCO}/ncrcat
v=$(ncdump -h $nc|grep PM25|wc -l)
a=$(ncdump -h $nc|grep AVERAGE|wc -l)
if [ $v != 0 ];then
  if  [ $a == 0 ];then
    #cmaq combined files
    VAR='TFLAG,PM1_TOT,PM25_TOT,PM10,VOC,PMC_TOT'
  else
  #version 700 nc directly from CAMx
    VAR='TFLAG,CO,NO2,SO2,O3,PNO3,PSO4,PNH4,PAR,CCRS,FCRS,CPRM,FPRM'
  fi
#camx>400, nc generated by pncgen from uamiv file
else
  VAR='TFLAG,CO,NO2,SO2,O3,PNO3,PSO4,PNH4,PAR,CCRS,FCRS,CPRM,FPRM'
fi
if ! [ -e $2 ];then
  touch $2
  $NCKS -O -v $VAR -d VAR,0,4 -d LAY,0 $1 $2
fi
```

## 檔案清理及空間維護

- 做完濃度場的nest down後，3維濃度場(CCTM_ACONC*)及粒徑分布(CCTM_APMDIAG*)檔案可以只留存第一層，以備作圖。
- 其餘檔案如不進一步偵錯或其他用途，可以全數刪除

### 清理項目

- `rm *DEP* CCTM_C* *cfg`
- CCTM_CGRID 之考量
  - domain3的起始濃度如果使用上層的內插，會發生塊狀不合理的濃度分布。
  - 使用過去模擬結果的CCTM_CGRID會是比較平緩變化的一個選項。
  - （似乎有留存的價值）

### 3維檔案之縮減

- 只需留下地面濃度與粒徑分率，後者在combine之會也沒有留存的必要。

```bash
for nc in $(ls *nc);do ncks -d LAY,0 $nc tmpnc;mv tmpnc $nc;done
```

### 空間維護

- 檢視使用者總磁碟機用量([TWCC - III 使用手冊:儲存資源與目錄位置](https://man.twcc.ai/@TWCC-III-manual/HyOgKIiuu))
  - `/usr/lpp/mmfs/bin/mmlsquota -u sinotec2 --block-size auto fs01 fs02`
  - fs01：/work
  - fs02：/home

```bash
                         Block Limits                                    |     File Limits
Filesystem type         blocks      quota      limit   in_doubt    grace |    files   quota    limit in_doubt    grace  Remarks
fs01       USR          110.8G       400G       500G     1.008G     none |    19790       0        0       85     none NCHC_AIcls.twcc.ai
fs02       USR          9.872G       200G       300G     488.4M     none |   194962       0        0       40     none NCHC_AIcls.twcc.ai
```

## 地面濃度圖製作

### 特殊python模組之安裝

- [wrf-python](../../utilities/Graphics/wrf-python/wrf-python.md)及[cartopy][cartopy]之安裝
  1. 安裝conda模組 `module load pkg/Anaconda3`
  2. 開新的環境或啟用既有的環境：`conda activate ncl_stable`
  3. 安裝wrf-python：`conda install -c conda-forge wrf-python`
- [cartopy][cartopy]之安裝：`pip install cartopy`

### gif之製作

- [m3nc2gif.py](../../utilities/Graphics/wrf-python/4.m3nc2gif.md)之修改
  - 國網pnetcdf的儲存會發生錯誤，造成濃度檔有缺值(1.E30)，程式需做因應處理。
- $gfs/[make_gifs.cs][make_gifs]之修改
  - [如前](1.ICBCforEA.md#cams數據之下載)所述，應用自行安裝套件的.py程式不能以腳本直接作為執行檔，需外加python

```bash
  for s in PM2.5 PM10 SO2 CO O3 NO2;do
    $bin/sub $pyt $bin/m3nc2gif.py $s.nc;done
```

## 結果檔案的傳輸

- 不建議傳輸大型檔案，如果需要，也必須壓縮後傳送。
- 國網上可以使用git
- 傳輸方案選擇詳見[公版模式輸入輸出檔案及傳輸管理][fs]

[nchc]: https://iservice.nchc.org.tw/nchc_service/nchc_service_twn3_hpc.php "國研院國網中心台灣杉三號(Taiwania 3)為國內提供開放服務申請的最大CPU高速計算主機(2021年)，擁有900個計算節點。"
[1]: https://sinotec2.github.io/Focus-on-Air-Quality/GridModels/TWNEPA_RecommCMAQ/exec/#1-主程式runcctm03csh "CMAQ Model System -> Recommend System -> 執行檔與程式庫 -> CCTM run scripts -> 1. 主程式(run.cctm.03.csh)"
[2]: https://sinotec2.github.io/Focus-on-Air-Quality/GridModels/TWNEPA_RecommCMAQ/exec/#2-模擬案例與時間projectconfig "CMAQ Model System -> Recommend System -> 執行檔與程式庫 -> CCTM run scripts -> 2-模擬案例與時間project.config"
[3]: https://sinotec2.github.io/Focus-on-Air-Quality/GridModels/TWNEPA_RecommCMAQ/exec/#3-科學設定檔cctmsourcev531ae7 "CMAQ Model System -> Recommend System -> 執行檔與程式庫 -> CCTM run scripts -> 3-科學設定檔cctm.source.v531.ae7"
[1dbcon]: https://sinotec2.github.io/Focus-on-Air-Quality/GridModels/BCON/1day_bc/ "逐日循序執行bcon.exe"
[icon]: https://sinotec2.github.io/Focus-on-Air-Quality/GridModels/ForecastSystem/10.fcst.cs/#下層icon "CMAQ Model System -> Recommend System -> 執行預報腳本之分段說明 -> CMAQ -> 下層ICON"
[make_gifs]: 15.make_gifs.md "地面濃度動畫批次製作"
[slurm]: ../../GridModels/TWNEPA_RecommCMAQ/module_slurm.md#slurm-commands "slurm-commands"
[evail]: ../TWNEPA_RecommCMAQ/module_slurm.md#csh-中執行module "csh腳本中執行module"
[trans]: ../../wind_models/WRFOUT/2.TransWrfout.md "因應intel MPI轉換wrfout格式"
[nco]: https://github.com/nco/nco "NCO NetCDF Operators@github"
[ncl]: https://www.ncl.ucar.edu/ "NCAR Command Language"
[fs]: ../../GridModels/TWNEPA_RecommCMAQ/IO_Files.md#公版模式輸入輸出檔案及傳輸管理 "公版模式輸入輸出檔案及傳輸管理"
[shk]: ../../GridModels/POST/2.do_shk.md#shkcs "整併濃度檔案項目之腳本"
[cartopy]: https://zhajiman.github.io/post/cartopy_introduction/ "Cartopy 系列：从入门到放弃，炸鸡人博客2021-03-23"