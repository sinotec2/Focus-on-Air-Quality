---
layout: default
title: m3nc2gif
parent: wrf-python
grand_parent: Graphics
last_modified_date: 2022-06-09 20:55:11
---

# m3nc檔案轉GIF
{: .no_toc }

<details open markdown="block">
  <summary>
    Table of contents
  </summary>
  {: .text-delta }
- TOC
{:toc}
</details>
---

## 背景
- USEPA Model3 的nc檔案格式([IOAPI](https://cmascenter.org/ioapi/documentation/all_versions/html/))雖然可以用VERDI或其他軟體打開、檢視，但還是不夠簡潔，尤其在公版模式、自動執行、遠端計算服務的過程中，如果能在模式計算完、後處理都結束後，自動產出GIF檔案，公布在網站上，會非常有幫助。
- 畫等值線圖對matploglib不是問題，但因為座標投影的問題，很容易發生位置扭曲的情形，還是需要用經緯度來校正。這也是wrf-python的強項。麻煩的是必須從wrf_out來讀取座標系統的轉換參數。
- matplotlib等值圖並不是raster圖檔，而是有內插效果的，不會像VERDI一樣鋸齒狀。
- 圖面上的濃度可能差異好幾個數量級，用線性等級等值線會集中在高值，圖面上太稀疏無資訊。VERDI也有線性與對數2種作法因應。分開作業才是合理的方式。
- 沿襲環保署提供公版後處理工具
  - extend='max'與
  - 在footnote提供圖面上最大值之數字
- 此處也同時解決了該工具的缺失：
  - 直接座標系統改成蘭伯投影系統
  - 256色階改成10～15階
  - 取消白色～淡藍色之間的漸層
  - 色階改成彈性判斷：線性或對數、階層數及有效位數自動調整(過去grads也是這樣設定的)。

## 輸入及輸出
### 引數
- m3nc檔案名稱
  - 檔名會寫在Title上，雖會去掉路徑，但字數長度還是有限，
  - 最好控制在10個字元之內。

### 輸入檔案
- m3nc檔案
- wrfout_d04：需存在同一工作目錄下

### 輸出檔案
- *v*_**NN**.png、*v*為模擬空氣品質項目，*NN*為00～99的時間序列。
- *v*.gif：最後整併結果

## png2gif檔案轉換
- imageMagics的convert指令是最佳的選擇，只需要將bash中的執行，放在python中直接進行就好了
### 程式外進行方式

```bash
for s in $(ls *_24.png);do 
  v=$(echo $s|cut -d'_' -f1)
  test $v=='PM25' && v=$(echo $s|cut -d'_' -f2)
  for png in $(ls ${v}*.png);do 
    convert -bordercolor white -trim $png tmp.png
    convert -bordercolor white -border 5%x5% tmp.png $png
  done
  convert  -dispose 2 -coalesce +repage -background none ${v}_*.png -size 607x774 ${v}.gif
done
```
### size的問題
- size會隨著圖形大小、邊界裁切等條件而異，應該不要設成定值比較保險
- 詢問png檔案的size可以用`convert '+v+'_00.png -format "%wx%h" info:`指令(參考[DETECT IMAGE SIZE](https://legacy.imagemagick.org/discourse-server/viewtopic.php?t=21871))
- python 可以用subprocess.checkout將結果讀成string，再寫成命令列即可確保gif的大小能夠一致。

## [m3nc2gif.py](https://github.com/sinotec2/Focus-on-Air-Quality/tree/main/utilities/Graphics/wrf-python/m3nc2gif.py)程式設計重點
### 座標系統
- 雖然說一般d4範圍並不大、搭配了行政區的邊界線也沒有造成誤解的可以，經緯度系統似乎沒有必要，但有經緯度格線看起來確實還是比較專業一點。
- 有座標值的內插可能是讓圖面看起來不再是raster圖，而是真正shaded圖的原因
- VERDI圖有網格數的XY座標，但還是長度為單位比較直覺。如果可以用公里為單位就更好了。

```python
from pyproj import Proj
from wrf import (getvar, to_np, get_cartopy)
...
pnyc = Proj(proj='lcc', datum='NAD83', lat_1=nc.P_ALP, lat_2=nc.P_BET,lat_0=nc.YCENT, lon_0=nc.XCENT, x_0=0, y_0=0.0)
...
x1d=[nc.XORIG+nc.XCELL*i for i in range(ncol)]
y1d=[nc.YORIG+nc.YCELL*i for i in range(nrow)]
X,Y=np.meshgrid(x1d,y1d)
lons, lats= pnyc(X,Y, inverse=True)
ncfile = Dataset('wrfout_d04')
p = getvar(ncfile, "pressure",timeidx=0)
cart_proj = get_cartopy(p)

...
    ax = plt.axes(projection=cart_proj)
    contours = plt.contourf(lons, lats, nc[v][t,0,:,:] ,
                       levels=level, #colors="rainbow",#"black",
                       norm=nm,
                       cmap=get_cmap("rainbow"),
                       transform=crs.PlateCarree(),
                       extend='max')
```
### 浮動的濃度等級
- 如前所述，濃度等級需要幾個項目是浮動的：
  1.線性或對數色階，改成彈性判斷
    - 最大/最小比值高於15:非線性、對數色階，適用在煙流增量分布，
    - 低於15:線性色階，適用在濃度變化不大的空品項目。
  2.極值的設定：全時間、全域、正值之
    - 99.9 percentile (等級之最大值)
    - 0.1 percentile (等級之最小值)
  3.濃度等級的階層數
    - 對數色階的數字不是等間距，沒有階層數的問題，一律使用10階即可
    - 線性色階間距的數字需要是整數，以便能直接辨識濃度值
    - 此處分為2類，最大值第1碼為[3,6,9]者取15階，其餘(7視為6)取10階
  4.有效位數(小數及大數)
    - 

## 結果比較
- 公版後處理工具、VERDI、m3nc2gif

| ![](https://github.com/sinotec2/Focus-on-Air-Quality/raw/main/assets/images/2019-01_NO2最大小時平均值增量.png) |![](https://github.com/sinotec2/Focus-on-Air-Quality/raw/main/assets/images/NO2_00VERDI.PNG) |![](https://github.com/sinotec2/Focus-on-Air-Quality/raw/main/assets/images/NO2_00.png) |
|:--:|:--:|:--:|
| <b>公版後處理工具</b>|<b>VERDI</b>|<b>m3nc2gif</b>|